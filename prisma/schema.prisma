generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MessageRole {
  user
  assistant
  system
}

model User {
  id            String         @id @default(uuid())
  email         String?        @unique
  name          String?
  createdAt     DateTime       @default(now())
  conversations Conversation[]
  orders        Order[]
  payments      Payment[]
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  title     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id])
  messages  Message[]
  agentRuns AgentRun[]

  @@index([userId])
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  role           MessageRole
  content        String
  createdAt      DateTime      @default(now())
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agentRuns      AgentRun[]

  @@index([conversationId, createdAt])
}

model Order {
  id          String     @id @default(uuid())
  userId      String
  orderNumber String     @unique
  status      String
  totalCents  Int
  currency    String     @default("USD")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  user        User       @relation(fields: [userId], references: [id])
  delivery    Delivery?
  invoice     Invoice?

  @@index([userId])
}

model Delivery {
  id            String   @id @default(uuid())
  orderId       String   @unique
  carrier       String
  trackingCode  String
  status        String
  estimatedDate DateTime?
  updatedAt     DateTime @updatedAt
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Payment {
  id         String   @id @default(uuid())
  userId     String
  provider   String
  status     String
  amountCents Int
  currency   String   @default("USD")
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  invoice    Invoice?
  refunds    Refund[]

  @@index([userId])
}

model Invoice {
  id          String   @id @default(uuid())
  orderId     String   @unique
  paymentId   String?  @unique
  number      String   @unique
  status      String
  subtotalCents Int
  taxCents    Int
  totalCents  Int
  currency    String   @default("USD")
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payment     Payment? @relation(fields: [paymentId], references: [id])
}

model Refund {
  id          String   @id @default(uuid())
  paymentId   String
  status      String
  amountCents Int
  createdAt   DateTime @default(now())
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
}

model AgentRun {
  id             String   @id @default(uuid())
  conversationId String
  messageId      String?
  agentType      String
  intent         String?
  confidence     Float?
  toolCalls      Json?
  toolResults    Json?
  timingsMs      Json?
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message        Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
}
